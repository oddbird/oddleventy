{%- import 'utility.macros.njk' as utility -%}
{%- import 'layout.macros.njk' as layout -%}

{%- set absoluteUrl = page.url | absoluteUrl(site.url) -%}
{%- set url_mentions = webmentions | mentionsForUrl(absoluteUrl) -%}
{%- set mentions = url_mentions | mentionTypes -%}

{#
  For now, we only show mentions on resource posts and oss pages.
#}
{%- set is_post = '_post' in (tags or []) -%}
{%- if mentions | length and (is_post or oss) -%}
<section id="webmentions" data-list="mentions" data-typeset>
  {{ layout.title('WebMentions') }}

  {% for webmention in mentions %}
    {% set attrs = {
      'class': 'webmention h-cite p-comment',
      'id': ['webmention', webmention['wm-id']] | join('-'),
      'data-mention': webmention['wm-property']
    } %}
    <article {{ utility.show_attrs(attrs) }}>
      <header>
        <h3 class="webmention-author{% if webmention.author %} p-author h-card{% endif %}">
          {{ utility.link_if(
            content=webmention.author.name,
            url=webmention.url,
            attrs={
              'class': 'u-url',
              'target': '_blank',
              'rel': 'noopener noreferrer'
            }
          ) }}
        </h3>
        <p class='webmention-meta'>
          {{ utility.datetime(
            start=webmention.published,
            pubdate=true
          ) }}
          <i>from</i>
          {{ webmention.url | getDomain }}
        </p>
      </header>

      <div class="webmention-content p-content">
        {{ webmention.content.value | safe }}
      </div>
    </article>
  {% endfor %}
</section>
{%- endif -%}
