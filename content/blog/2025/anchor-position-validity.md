---
title: How to find an acceptable anchor element
sub: Why your anchor positioning isn't working
date: 2025-01-12
image:
  src: blog/2024/anchor1.jpg
  alt: >
    A rusty anchor hanging with the sea in the background.
author: james
sponsors: true
tags:
  - Article
  - Anchor Positioning
  - CSS
summary: |
  It can be frustrating to track down why your anchor isn't being found.
  There's a good reason, but it can be opaque and confusing.
---

{% import 'embed.macros.njk' as embed %}

{% callout 'note', false %}

**TL;DR:** There are many ways a positioned element can fail to find anchor. The
most common issues can be avoided by:

- making the anchor and the positioned element siblings, and
- putting the anchor first in the DOM.

Go give that a try, and then come back and find out why, and what to check next if that didn't work.

I'll wait.

{% endcallout %}

## The problem

Anchor positioning has a [ton of
possibilities](../2024/anchor-position-yearbook.md), and is fun to play around
with. But then, things start to not work. The positioned element can't find the
anchor, it isn't positioned correctly, and Dev Tools just says `--your-anchor is
not defined`.

Then you need to figure out why... is it related to how you've structured your
markup, a browser bug or partial implementation, or maybe it's related to how
you're using Shadow DOM?

There are many reasons why it can fail, but they all fail in the same way. This
makes it really hard to troubleshoot and recover from.

## Troubleshooting Checklist

1. Is your anchor a parent of the positioned element? While this can work, there
   are multiple ways this can break.
   [More](#anchor-as-a-parent-to-the-positioned-element)
1. Is the anchor an element or valid pseudo-element?
   [More](#valid-anchor-pseudo-elements)
1. Are both the anchor and positioned elements in the same `anchor-scope`
   subtree? [More](#anchor-scope)
1. If your anchor is absolutely positioned, does it come before the positioned
   element in the DOM? [More](#absolute-anchor-order)
1. Is your anchor in a higher top layer (generated by a popover or modal dialog)
   than the positioned element? That won't work. [More](#top-layer)
1. Is the `anchor-name` defined by styles in the same shadow tree where it is
   referred to? [More](#anchoring-across-shadow-trees)

If your issue isn't on this list- let us know how you fixed it! This list isn't
exhaustive, and omits some cases with hidden content, fixed position anchors,
and other less likely edge cases.

We're also available for office hours to help work through your specific case.

## Anchor as a parent to the positioned element

While a positioned element can be a child of the anchor, this is the primary
place where I've seen anchor positioning fail.

The spec has specific requirements regarding the relationship between the
containing blocks of the anchor and the positioned element, and containing
blocks are essentially invisible, except in their effects, to developers. This
leads to unexpected and surprising behavior.

{% callout 'note', false %}

While containing blocks deserve an entire deep dive post, you'll have to be
content with a [brief note](#containing-blocks) at the end of this article.

{% endcallout %}

The containing block for the positioned element can not be a descendant of the
containing block for the anchor. Put a different way, the space in which the
positioned element can be positioned can not be smaller than the space in which
the anchor can be positioned. (Note: this is technically less accurate, but it
helps me visualize why this is important.)

Crucially, if the anchor element is a parent to the positioned element and
creates a containing box, anchor positioning will not work. The positioned
element's containing box will be the anchor, and the anchor's containing box
will be one of its ancestors.

TODO: Is there a visual way of showing this?

There are many reasons that will cause the anchor element will create a
containing block, and positioned elements that are children will not work.

  - If you set a `position` besides `static`
  - If you transform the element somehow, with `transform`, `translate`,
    `scale`, etc.
  - If it's a query container for container size queries.

This is not an exhaustive list. Because there are so many ways to get into this
situation unexpectedly, I recommend not nesting postioned elements inside the
anchor.

## Valid anchor pseudo-elements

Most anchors will be elements, but if you're using a pseudo-element, not all
qualify. The pseudo-element must be a "fully styleable tree-abiding
pseudo-element". Tree-abiding pseudo-elements behave like regular elements,
unlike pseudo-elements like `::first-letter` or `::spelling-error`. Some, like
`::marker` or `::placeholder`, are not fully styleable, as they only allow some
CSS properties.

The valid pseudo-elements are `::before`, `::after` and
`::file-selector-button`. `::-webkit-slider-thumb` currently works as an anchor
in Chrome, but as it is experimental and not part of any CSS spec, it's unclear
whether it should.

## Anchor scope

Anchor scope is great for making reusable anchoring rules, especially if you are
anchoring on a list item or reusing styles. If you're using `anchor-scope`,
verify that both the anchor and positioned element are descendants of the
element with the `anchor-scope` rule, or if the anchor itself has the
`anchor-scope` rule, that the positioned element is a descendant of the anchor.

## Absolute anchor order

This is the motivation behind the recommended solution to have the anchor come
before the positioned element in the DOM.

Generally, absolutely positioned elements are rendered after relatively
positioned elements. If the anchor element is absolutely positioned, then the
positioned element must come after the anchor in the DOM.

{{ embed.codepen( id='xbKpedP', title='Absolute anchor order', user='jamessw',
  height=300 ) }}

{% callout 'note', false %}

The "after the anchor in the DOM" check happens on the `flat tree`, which means
that slotted content is placed and shadow hosts are filled with their children.

{% endcallout %}

## Top Layer

If you are using dialogs as modals or popovers, you are creating top layers. If
the anchor element is in a higher top layer than the positioned element, the
positioned element will not be able to locate the anchor.

## Anchoring across shadow trees

An element in one shadow tree can anchor to an element in another shadow tree,
as long as the anchor name is defined in the same shadow tree styles where it is
referred to.

TODO: Example

## Containing blocks

{% callout 'note', false %}

Notably, a containing block is not a box (it is a
rectangle)...

[CSS Display Module Level 4
spec](https://drafts.csswg.org/css-display-4/#containing-block)

{% endcallout %}

Great, I totally understand...

You likely have run into containing blocks before. When you are positioning
something with absolute positioning, it is positioned relative to its containing
block.

{{ embed.codepen( id='NPKyRPm', title='Containing box for absolutely positioned
  element', user='jamessw', height=300 ) }}

If you use percentages to define widths and heights, these are calculated
relative to the element's containing block.

To figure out an element's containing block, find the ancestor element that the
element's position and size are relative to. If the element is fixed position,
the containing block can be the viewport.

I've found MDN's guide on [Identifying the containing
block](https://developer.mozilla.org/en-US/docs/Web/CSS/Containing_block#identifying_the_containing_block)
a helpful resource to unravel the containing block.

## Potential solutions

Troubleshooting why an anchor is not found is not fun or easy. Anchor
Positioning is in its early days, but as adoption grows, I hope we can find ways
to make this easier.

An important part will be to improve dev tooling when an anchor is not found.
Perhaps next to a `--anchor is not found` message, there's a crosshair selector
to select the DOM element you thought would be the anchor. Then the Dev Tools
could provide a specific message of why that particular combination would not
work.

Another useful improvement would be a method to identify an element's containing
block. Perhaps there could be a new `:containing-block` pseudo-class that
selects the element that creates the containing block, or a
`HTMLElement.containingBlock` attribute. Because this is primarily useful while
developing, it may be better to instead add a way of finding this in Dev Tools,
instead of through browser APIs.
